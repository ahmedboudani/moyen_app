{% extends "base.html" %}

{% block title %}Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬{% endblock %}

{% block content %}
<div class="container" id="resultsContainer">
    <h2 class="text-center">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h2>
    <div class="general1">
        <p>ğŸ“Œ Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„ØªØ±Ø¨ÙŠØ© Ù„ÙˆÙ„Ø§ÙŠØ©: {{ general_info.directorate if general_info else '' }}</p>
        <p>ğŸ« Ø§Ù„Ù…Ø¤Ø³Ø³Ø©: {{ general_info.institution if general_info else '' }}</p>
    </div>
    <div class="general2">
        <p>ğŸ‘¨â€ğŸ« Ø§Ù„Ø£Ø³ØªØ§Ø°: {{ general_info.teacher if general_info else '' }}</p>
        <p>ğŸ“š Ø§Ù„Ù…Ø§Ø¯Ø©: {{ general_info.subject if general_info else '' }}</p>
    </div>
    <hr>
    <center>
       <form method="get" action="{{ url_for('results') }}" class="search-form">
    <div class="search-container">
        <div class="search-item">
            <label>Ø§Ù„Ù‚Ø³Ù…:</label>
            <select name="class_id">
                <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                {% for c in classes %}
                    <option value="{{ c.id }}" {% if selected_class == c.id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="search-item">
            <label>Ø§Ù„ÙØµÙ„:</label>
            <select name="semester">
                <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                {% for semester in semesters %}
                    <option value="{{ semester }}" {% if selected_semester == semester %}selected{% endif %}>{{ semester }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="search-item">
            <button class="btn" type="submit">Ø¨Ø­Ø«</button>
        </div>
    </div>
</form>
        {% if students %}
        <div class="frm1" style="margin-top: 10px;">
            <a style="margin-top:10px;"
                href="{{ url_for('export_pdf_route', class_id=selected_class or '', semester=selected_semester or '') }}" 
                class="btn">ØªØµØ¯ÙŠØ± PDF</a>
        </div>
        <form id="exportForm" class="export-form">
            <div class="form-group">
                <label for="excelFile">ğŸ“‚ Ø§Ø®ØªØ± Ù…Ù„Ù Excel:</label>
                <input type="file" id="excelFile" accept=".xlsx" required>
            </div>
            
            <div class="form-group">
                <label for="sheetName">ğŸ“„ Ø§Ø®ØªØ± Ø§Ù„ØµÙØ­Ø©:</label>
                <select id="sheetName" required>
                    <option value="1">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
                    <option value="2">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
                    <option value="3">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
                    <option value="4">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©</option>
                    <option value="5">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø®Ø§Ù…Ø³Ø©</option>
                </select>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn export-excel-btn">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
            </div>
        </form>
        

        <script>
document.getElementById('exportForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const fileInput = document.getElementById('excelFile');
    const sheetName = document.getElementById('sheetName').value;

    if (!fileInput.files.length || !sheetName) {
        alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙØ­Ø©');
        return;
    }

    // ğŸŸ¢ Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ØµÙØ­Ø©
    const tableRows = document.querySelectorAll("table.tbl tr");
    const students = [];
    for (let i = 1; i < tableRows.length; i++) {
        const cells = tableRows[i].querySelectorAll("td");
        if (cells.length > 0) {
            students.push({
                fullname: cells[0]?.textContent.trim() || "",
                assessment: cells[3]?.textContent || "",
                test: cells[4]?.textContent || "",
                avg_controle: cells[5]?.textContent || "",
                exam: cells[6]?.textContent || "",
                average: cells[7]?.textContent || "",
                note: cells[8]?.textContent || ""
            });
        }
    }

    // ğŸ”¹ ØªØ¬Ù‡ÙŠØ² FormData Ø¨Ø¹Ø¯ Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const formData = new FormData();
    formData.append('excel_file', fileInput.files[0]);
    formData.append('sheet_name', sheetName);
    formData.append('students_data', JSON.stringify(students));

    try {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch API Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const response = await fetch('/export_excel', {
            method: 'POST',
            body: formData
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© JSONØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£
            const data = await response.json();
            alert('âŒ Ø®Ø·Ø£: ' + (data.error || 'ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±'));
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© JSONØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†Ø²ÙŠÙ„
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¥Ù„Ù‰ blob
            const blob = await response.blob();
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = fileInput.files[0].name;
            document.body.appendChild(a);
            a.click();
            
            // ØªÙ†Ø¸ÙŠÙ
            window.URL.revokeObjectURL(downloadUrl);
            document.body.removeChild(a);
            
            alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
    }
});


</script>


        {% endif %}
    </center>

    <hr>

    {% if selected_class and selected_semester %}
        <div style="text-align: center; font-weight: bold; font-size: large; margin-bottom: 10px;">
            <span>
                Ø§Ù„Ù‚Ø³Ù…: 
                {% for c in classes %}
                    {% if c.id == selected_class %}
                        {{ c.name }}
                    {% endif %}
                {% endfor %}
            </span>
            <span style="margin-right: 50px;"></span> 
            <span>{{ selected_semester }}</span>
        </div>
    {% endif %}

    <center>
    <table class="tbl" border="1" width="100%" colwidths="[120,50,50,50,50,50,90]">
        <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ù‚Ø³Ù…</th>
            <th>Ø§Ù„ÙØµÙ„</th>
            <th>Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</th>
            <th>Ø§Ù„ÙØ±Ø¶</th>
            <th>Ù… Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</th>
            <th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
            <th>Ø§Ù„Ù…Ø¹Ø¯Ù„</th>
            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>

        {% for s in students|sort(attribute='fullname') %}
            {% if s.grades_for_semester %}
                {% for g in s.grades_for_semester %}
                <tr>
                    <td>{{ s.fullname }}</td>
                    <td>{{ s.class_rel.name }}</td>
                    <td>{{ s.semester }}</td>
                    <td>{{ g.assessment }}</td>
                    <td>{{ g.test }}</td>
                    <td>{{ g.avg_controle }}</td>
                    <td>{{ g.exam }}</td>
                    <td>{{ g.average }}</td>
                    <td>{{ g.note }}</td>
                </tr>
                {% endfor %}
            {% endif %}
        {% endfor %}
    </table>
    </center>

    <hr>
    <center>
    <table class="statistics" border="0" width="25%">
        <tr>
            <th>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°</th>
            <th>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù‚Ø³Ù…</th>
            <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</th>
        </tr>
        <tr>
            <td>{{ num_students }}</td>
            <td>{{ "%.2f"|format(class_average) }}</td>
            <td>{{ "%.2f"|format(success_percentage) }}%</td>
        </tr>
    </table>
    </center>
</div>

<style>
    .container {
        width: 98%;
        background-color:#d8d8e2;
        padding:10px;
        border-radius: 10px;
        box-shadow: 0px 4px 12px ;
        text-align: center;
        margin: auto;
    }
    .frm{
        display: flex;
        justify-content: center;
        width:35%;
    }
    .btn{
        color:white;
        background-color: rgb(34, 34, 39);
        width:auto;
        padding: 5px 15px;
        border-radius: 10px;
    }
    .frm1{
        display: flex; 
        justify-content: center; 
        margin: auto; 
        gap: 10px;
    }
    .search-container {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin: 10px auto;
}

.search-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.search-form select {
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

.search-form .btn {
    margin: 0;
    padding: 5px 15px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.export-form {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-top: 10px;
    
}

.export-form .form-group {
    display: flex;
    align-items: center;
    gap: 5px;
}

.export-form .form-group label {
    white-space: nowrap;
}

.export-excel-btn {
    position: relative;
    bottom: 8px;
}

</style>
{% endblock %}
